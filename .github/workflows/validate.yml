name: Validate

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  commits:
    name: Commits
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Validate conventional commits
        env:
          PR_BASE: ${{ github.event.pull_request.base.sha }}
          PR_HEAD: ${{ github.event.pull_request.head.sha }}
        run: |
          pattern='^(feat|fix|perf|build|chore|ci|docs|style|refactor|test)(\([^)]+\))?!?: .+'
          fail=0
          for sha in $(git rev-list "$PR_BASE".."$PR_HEAD"); do
            msg=$(git log -1 --format=%s "$sha")
            if ! echo "$msg" | grep -qE "$pattern"; then
              echo "❌ $msg"
              fail=1
            fi
          done
          if [ "$fail" -ne 0 ]; then
            echo ""
            echo "Commit messages must follow Conventional Commits: type[(scope)]: description"
            echo "Allowed types: feat, fix, perf, build, chore, ci, docs, style, refactor, test"
            exit 1
          fi
          echo "✅ All commit messages follow Conventional Commits"

  hassfest:
    name: Hassfest
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: home-assistant/actions/hassfest@master

  hacs:
    name: HACS
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hacs/action@main
        with:
          category: integration
          ignore: brands
          comment: false
          github_token: ${{ secrets.GITHUB_TOKEN }}

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v6
      - run: uv run ruff check .
      - run: uv run ruff format --check .

  mypy:
    name: Mypy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v6
      - run: uv run mypy custom_components/home_rules tests

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v6
      - run: uv run coverage run -m pytest tests/ -v --tb=short
      - run: uv run coverage report --include="custom_components/home_rules/*" --fail-under=80
